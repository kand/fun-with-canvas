<html ng-app='dotsApp'>
  <head>
    <title>DOTS</title>

    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/angularjs/1.2.23/angular.min.js"></script>
    <script src="https://code.jquery.com/jquery-2.1.3.min.js" type="text/javascript"></script>

    <style>
      #dotCanvas {
        border: 1px solid black;
      }

      button.active {
        background-color: #00ff00;
        color: #fff;
      }
    </style>
  </head>

  <body>
    <div ng-controller="DotsController">
      <canvas
          id="dotCanvas"
          ng-click="drawDot($event)"
          ng-mousedown="startFreeDraw($event)"
          ng-mousemove="doFreeDraw($event)"
          ng-mouseup="stopFreeDraw($event)"
          width="500"
          height="500">
      </canvas>
      <div>
        <button
            id="btnDots"
            ng-click="drawMode = drawingModes.DOTS"
            ng-class="{'active': drawMode === drawingModes.DOTS}">
          DOTS
        </button>
        <button
            id="btnLines"
            ng-click="drawMode = drawingModes.FREE"
            ng-class="{'active': drawMode === drawingModes.FREE}">
          FREE
        </button>
        <button
            ng-click="clearCanvas()">
          CLEAR
        </button>
        <span ng-if="inPath > -1">In Path: {{ inPath }}</span>
      </div>
      <div>
        <ul>
          <li ng-repeat="dot in dots">({{ dot.x }}, {{ dot.y }})</li>
        </ul>
      </div>
    </div>

    <script type="text/javascript">
      var canvas = document.getElementById('dotCanvas');
      var $canvas = $(canvas);
      var context = canvas.getContext('2d');

      var dotsApp = angular.module('dotsApp', []);

      var getCursorPosition = function($event) {
        var x;
        var y;
        var canoffset = $canvas.offset();

        return {
          x: $event.clientX + document.body.scrollLeft + document.documentElement.scrollLeft - Math.floor(canoffset.left),
          y: $event.clientY + document.body.scrollTop + document.documentElement.scrollTop - Math.floor(canoffset.top) + 1
        };
      };

      dotsApp.controller('DotsController', function ($scope) {
        $scope.drawingModes = {
          DOTS: 'dots',
          FREE: 'free'
        };

        $scope.drawMode = $scope.drawingModes.DOTS;

        $scope.inPath = -1;
        $scope.drawingLine = false;
        $scope.paths = [];
        var currPath;
        $scope.startFreeDraw = function ($event) {
          if ($scope.drawMode === $scope.drawingModes.FREE) {
            var pos = getCursorPosition($event);
            currPath = new Path2D();
            currPath.moveTo(pos.x, pos.y);
            $scope.drawingLine = true;
          }
        };
        $scope.doFreeDraw = function ($event) {
          var pos = getCursorPosition($event);
          $scope.inPath = -1;
          for (var i = 0; i < $scope.paths.length; i++) {
            if (context.isPointInPath($scope.paths[i], pos.x, pos.y)) {
              $scope.inPath = i;
            }
          }

          if ($scope.drawMode === $scope.drawingModes.FREE && $scope.drawingLine) {
            currPath.lineTo(pos.x, pos.y);
            context.stroke(currPath);
          }
        };
        $scope.stopFreeDraw = function ($event) {
          if ($scope.drawMode === $scope.drawingModes.FREE && $scope.drawingLine) {
            currPath.closePath();
            context.fillStyle = 'rgba(255, 0, 0, 0.5)';
            context.fill(currPath);
            context.stroke(currPath);
            $scope.drawingLine = false;
            $scope.paths.push(currPath);
          }
        };

        $scope.dots = [];
        $scope.drawDot = function ($event) {
          if ($scope.drawMode === $scope.drawingModes.DOTS) {
            var pos = getCursorPosition($event);
            var r = 2;

            context.beginPath();
            context.arc(pos.x, pos.y, r, 0, 2 * Math.PI);
            context.fillStyle = '#000';
            context.fill();
            context.stroke();

            $scope.dots.push({x: pos.x, y: pos.y});
          }
        };

        $scope.clearCanvas = function () {
          context.clearRect(0, 0, canvas.width, canvas.height);
        };
      });
    </script>
  </body>

</html>
